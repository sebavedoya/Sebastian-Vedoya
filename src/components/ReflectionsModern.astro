---
/** Reflexiones — Masonry + Modal con reveal temprano */
const reflections = [
  {
    id: "ref-ashby",
    title: "La ley de la variedad requerida y el desafío comunicacional contemporáneo",
    dek: "Cómo la variedad del entorno obliga a rediseñar estrategias y equipos.",
    body: `La ley de la variedad requerida, postulada por Ross Ashby en 1958, señala que solo la variedad puede absorber variedad. En comunicación contemporánea, esto implica diseñar organizaciones y flujos que igualen (o domestiquen) la complejidad del entorno: diversificar formatos, ajustar ritmos editoriales, crear bucles de feedback, y construir tableros que reduzcan la entropía informativa. Sin esa arquitectura, las vocerías y mensajes quedan expuestos a shocks externos, errores de coordinación y narrativas adversas que amplifican el ruido.`
  },
  {
    id: "ref-autoridades",
    title: "Autoridades y redes sociales: una confusión frecuente",
    dek: "No todo es ‘noticiero personal’: rol institucional vs. posicionamiento.",
    body: `Pese a lo que muchas autoridades creen, las redes sociales institucionales no son su canal de noticias 24/7. Tienen mandato público, audiencias específicas y métricas que deben alinearse con objetivos de política pública. El desafío es coordinar el ‘perfil autoridad’ con el ‘perfil institucional’: mensajes coherentes, calendario cruzado, narrativa compartida y métricas diferenciadas (servicio/valor público vs. visibilidad de la figura).`
  },
  {
    id: "ref-miedo",
    title: "Comunicar sin miedo",
    dek: "Confianza operativa y preparación: la dupla que baja la ansiedad.",
    body: `Durante una visita a Rapa Nui entrevisté a la alcaldesa Elizabeth Arévalo Pakarati. La lección: la confianza operativa nace de la preparación y de equipos con roles claros. Cuando hay guiones de crisis, matrices de mensajes y simulaciones previas, la ansiedad baja y la comunicación fluye. Sin ese andamiaje, el miedo empuja a la improvisación, y la improvisación, al error.`
  },
];
---

<section id="reflexiones" class="section section--tight-top">
  <div class="container">
    <h2 class="h2">Reflexiones</h2>
    <p class="section-intro">Apuntes estratégicos y marcos conceptuales aplicados a comunicación pública.</p>

    <div class="ref-grid" data-ref-grid>
      {reflections.map((r) => (
        <article class="ref-card reveal" id={r.id}>
          <header class="ref-head">
            <h3 class="ref-title">{r.title}</h3>
            <p class="ref-dek">{r.dek}</p>
          </header>
          <footer class="ref-foot">
            <button class="btn-outline ref-cta" data-open={r.id} aria-haspopup="dialog" aria-controls={`dlg-${r.id}`}>
              Leer completa
            </button>
          </footer>

          {/* Modal */}
          <dialog class="ref-modal" id={`dlg-${r.id}`} aria-labelledby={`dlg-title-${r.id}`}>
            <form method="dialog" class="ref-close-wrap">
              <button class="ref-close" aria-label="Cerrar">✕</button>
            </form>
            <article class="ref-article">
              <h3 id={`dlg-title-${r.id}`}>{r.title}</h3>
              <p class="ref-body">{r.body}</p>
            </article>
          </dialog>
        </article>
      ))}
    </div>
  </div>

  <script is:inline>
    // Reveal temprano (entra cuando el 10% inferior del viewport toca la grilla)
    const grid = document.querySelector('[data-ref-grid]');
    if (grid) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            grid.querySelectorAll('.reveal').forEach(el => el.classList.add('revealed','reveal--in','fade-in--visible'));
            io.disconnect();
          }
        });
      }, { rootMargin: '0% 0% -90% 0%', threshold: 0 }); // muy temprano
      io.observe(grid);
    }

    // Modales
    document.querySelectorAll('.ref-cta').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-open');
        const dlg = document.getElementById('dlg-'+id);
        if (!dlg) return;
        if (typeof dlg.showModal === 'function') dlg.showModal();
        else dlg.setAttribute('open','open');
      });
    });

    document.querySelectorAll('.ref-modal').forEach(dlg => {
      // Cerrar con click en backdrop
      dlg.addEventListener('click', (e) => {
        const rect = dlg.getBoundingClientRect();
        const isBackdrop = e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom;
        if (isBackdrop) dlg.close();
      });
      // Cerrar con ESC
      dlg.addEventListener('cancel', (e) => { e.preventDefault(); dlg.close(); });
    });
  </script>

  <style>
    /* Masonry responsive (columnas fluidas) */
    .ref-grid{
      columns: 1;
      column-gap: 1rem;
    }
    @media (min-width: 760px){ .ref-grid{ columns: 2; } }
    @media (min-width: 1100px){ .ref-grid{ columns: 3; } }

    .ref-card{
      break-inside: avoid;
      display: flex; flex-direction: column; justify-content: space-between;
      background:#121821; border:1px solid #1f2a37; border-radius:16px;
      padding:1rem; margin:0 0 1rem 0;
      box-shadow:0 6px 22px rgba(0,0,0,.45);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .ref-card:hover{ transform: translateY(-2px); box-shadow:0 10px 28px rgba(0,0,0,.55); }

    .ref-head{ margin: .2rem 0 .6rem; }
    .ref-title{ margin:0 0 .35rem; font-size:1.08rem; color:#eaf2f8; }
    .ref-dek{ margin:0; color:#c9d3df; }

    .ref-foot{ margin-top:.9rem; display:flex; justify-content:flex-start; }
    .ref-cta{ font-weight:700; }

    /* Modal */
    .ref-modal{
      width:min(820px, 94vw);
      max-height:90dvh;
      border:none; padding:0; border-radius:18px; overflow:hidden;
      background:#0f141b; color:#e6eef4;
      box-shadow:0 30px 120px rgba(0,0,0,.65);
    }
    .ref-modal::backdrop{ background:rgba(3,6,10,.65); backdrop-filter:blur(2px); }
    .ref-close-wrap{ position:absolute; top:10px; right:10px; z-index:2; }
    .ref-close{
      border:1px solid #263242; background:#111a23; color:#e6eef4;
      width:36px; height:36px; border-radius:999px; cursor:pointer;
    }
    .ref-article{ padding:1.25rem 1.25rem 1.4rem; }
    .ref-article h3{ margin:.1rem 0 .5rem; }
    .ref-body{ color:#c9d3df; line-height:1.75; white-space:pre-wrap; }
  </style>
</section>
